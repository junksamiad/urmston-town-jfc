# Product Requirements Document
## FA Full-Time Fixtures Scraping System
### Urmston Town Juniors FC

---

## 1. Executive Summary

### Project Overview
Automated system to scrape fixture data from FA Full-Time widget and display on Urmston Town Juniors FC website with custom styling and enhanced functionality.

### Problem Statement
- FA Full-Time widget uses legacy JavaScript that conflicts with React/Next.js
- Limited styling options with the official widget
- No data persistence or historical tracking
- Widget occasionally fails or shows outdated data

### Solution
Build an automated scraping pipeline that extracts fixture data from FA Full-Time and stores it in a MySQL database on Hostinger, allowing full control over presentation and data management.

---

## 2. System Architecture

### High-Level Flow
```
FA Full-Time ‚Üí Hidden HTML Page ‚Üí AWS Lambda (Puppeteer) ‚Üí PHP Endpoint ‚Üí MySQL ‚Üí API ‚Üí Next.js Site
```

### Components

#### 2.1 FA Widget Host Page
- **Location**: `https://pages.urmstontownjfc.co.uk/fa-widget.html` (hidden)
- **Purpose**: Hosts FA Full-Time widgets for scraping
- **Technology**: Plain HTML with FA JavaScript widgets
- **Widget Codes**: 
  - `783655865` for Timperley & District JFL (U9, U10, U15, U16 teams)
  - `84363452` for Salford League (U7, U8, U13 teams)

#### 2.2 AWS Lambda Scraper
- **Function**: `urmston-fixtures-scraper` (Account: 650251723700)
- **Schedule**: EventBridge rules running twice daily (9 AM and 3 PM UTC)
- **Technology**: Node.js with Puppeteer (@sparticuz/chromium)
- **Container**: 253MB optimized Docker image on ECR
- **Function**: Visits widget page, waits for data load, extracts fixture information

#### 2.3 Data Ingestion Endpoint
- **Location**: `https://pages.urmstontownjfc.co.uk/api/fixtures/ingest.php`
- **Method**: POST
- **Authentication**: Secret token in headers
- **Function**: Receives scraped data, validates, and stores in MySQL

#### 2.4 MySQL Database
- **Host**: Hostinger MySQL (already available)
- **Database Name**: `u790502142_fixtures`
- **Tables**: `fixtures`, `teams`, `scrape_logs`

#### 2.5 Public API Endpoint
- **Location**: `https://pages.urmstontownjfc.co.uk/api/fixtures/get.php`
- **Method**: GET
- **Parameters**: team, date_from, date_to, status
- **Response**: JSON fixture data

#### 2.6 Next.js Integration
- **Location**: Existing fixtures page
- **Function**: Fetches from API and displays with enhanced UI
- **Features**: Team filtering, date grouping, results/upcoming tabs
- **Enhanced Display**: Two-line format showing League || Pitch || Venue
- **Airtable Integration**: Pitch allocations and venue details for Urmston teams

---

## 3. Technical Specifications

### 3.1 Database Schema

```sql
-- Fixtures table
CREATE TABLE fixtures (
    id INT AUTO_INCREMENT PRIMARY KEY,
    fixture_date DATETIME NOT NULL,
    home_team VARCHAR(100) NOT NULL,
    away_team VARCHAR(100) NOT NULL,
    venue VARCHAR(200),
    competition VARCHAR(100),
    home_score INT DEFAULT NULL,
    away_score INT DEFAULT NULL,
    status ENUM('upcoming', 'completed', 'postponed', 'cancelled') DEFAULT 'upcoming',
    age_group VARCHAR(20),
    raw_data TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY unique_fixture (fixture_date, home_team, away_team)
);

-- Teams table (for our teams only)
CREATE TABLE teams (
    id INT AUTO_INCREMENT PRIMARY KEY,
    team_name VARCHAR(100) NOT NULL,
    age_group VARCHAR(20),
    active BOOLEAN DEFAULT TRUE
);

-- Scrape logs for monitoring
CREATE TABLE scrape_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    scrape_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    fixtures_found INT,
    fixtures_updated INT,
    fixtures_new INT,
    success BOOLEAN,
    error_message TEXT
);
```

### 3.2 AWS Lambda Configuration

```yaml
Function: urmston-fixtures-scraper
Region: eu-north-1
Memory: 1024 MB
Timeout: 120 seconds
Runtime: Container (Node.js 20)
Architecture: x86_64

Environment Variables:
  API_TOKEN: a8f3d2b1c9e4f7a6d5b8c3e2f1a9b4c7
  WIDGET_URL: https://pages.urmstontownjfc.co.uk/fa-widget.html
  API_URL: https://pages.urmstontownjfc.co.uk/api/fixtures/ingest.php

EventBridge Rules:
  - urmston-fixtures-09-00: cron(0 9 * * ? *)  # 9 AM UTC daily
  - urmston-fixtures-15-00: cron(0 15 * * ? *) # 3 PM UTC daily
```

### 3.3 Scraper Logic (Puppeteer)

```javascript
// Key functionality (Lambda handler)
1. Launch Puppeteer with @sparticuz/chromium
2. Navigate to FA widget page
3. Wait for both widget selectors:
   - '#lrep783655865' (Timperley)
   - '#lrep84363452' (Salford)
4. Extract from both widgets:
   - Date/time
   - Home team
   - Away team
   - Venue
   - Score (if available)
   - Competition (league name)
5. Transform to JSON with league identification
6. POST combined data to PHP endpoint with auth token
7. Return success/failure status to Lambda
```

### 3.4 PHP Endpoints

#### Ingestion Endpoint
```php
// /api/fixtures/ingest.php
- Verify auth token
- Validate JSON structure
- Connect to MySQL
- Upsert fixtures (update if exists, insert if new)
- Log scrape results
- Return success/failure response
```

#### Public API Endpoint
```php
// /api/fixtures/get.php
- Accept query parameters
- Build SQL query with filters
- Return JSON response with CORS headers
- Cache for 5 minutes
```

---

## 4. Security Considerations

### Authentication
- **Scraper ‚Üí PHP**: Secret token in Authorization header
- **PHP ‚Üí MySQL**: Credentials stored in `.env` file
- **Public API**: No auth required (read-only public data)

### Data Validation
- Sanitize all inputs before database insertion
- Escape special characters
- Validate date formats
- Limit response sizes

### Rate Limiting
- Implement basic rate limiting on public API
- Maximum 60 requests per minute per IP

---

## 5. Development Phases

### Phase 1: Infrastructure Setup (2 hours) ‚úÖ COMPLETE
1. ‚úÖ Setup FA widget HTML page (COMPLETE - 2025-09-12)
2. ‚úÖ Create MySQL database and tables (COMPLETE - 2025-09-12)
3. ‚úÖ Create PHP endpoint structure (COMPLETE - 2025-09-12)
4. ‚è≥ Initialize GitHub repository

### Phase 2: Scraping Pipeline (3 hours) ‚úÖ **COMPLETE**
1. ‚úÖ Build Puppeteer scraper (COMPLETE - 2025-09-12)
2. ‚úÖ Test local scraping (COMPLETE - 2025-09-12)
3. ‚úÖ Setup AWS Lambda (COMPLETE - 2025-09-13)
4. ‚úÖ Configure environment variables (COMPLETE - 2025-09-13)

### Phase 3: Data Layer (2 hours) ‚úÖ COMPLETE
1. ‚úÖ Build ingestion endpoint (COMPLETE - 2025-09-12)
2. ‚úÖ Implement database operations (COMPLETE - 2025-09-12)
3. ‚úÖ Create public API endpoint (COMPLETE - 2025-09-12)
4. ‚úÖ Add error logging (COMPLETE - 2025-09-12)

### Phase 4: Integration (2 hours) ‚úÖ **COMPLETE - ENHANCED**
1. ‚úÖ Update Next.js fixtures page (COMPLETE - 2025-09-13)
2. ‚úÖ Connect to new API (COMPLETE - 2025-09-13)
3. ‚úÖ Implement caching (5-minute client-side caching)
4. ‚úÖ Style and polish (Loading states, error handling)
5. ‚úÖ **Deploy to production** (COMPLETE - 2025-09-13 via Hostinger File Manager)
6. ‚úÖ **Enhanced two-line display format** (COMPLETE - 2025-09-13)
7. ‚úÖ **Pitch allocation visibility** (LIVE - Airtable integration)

### Phase 5: Testing & Deployment (1 hour)
1. End-to-end testing
2. Error handling
3. Monitoring setup
4. Documentation

---

## 6. Success Metrics

- **Reliability**: 95% successful scrape rate
- **Freshness**: Data updated within 12 hours of changes
- **Performance**: API response < 200ms
- **Uptime**: 99.9% availability

---

## 7. Future Enhancements

- League table integration
- Team statistics
- Push notifications for fixture changes
- Historical match reports
- Multi-league support
- Calendar export (iCal)

---

## 8. Technical Contacts

- **GitHub**: junksamiad@gmail.com
- **Hostinger Account**: SSH enabled (Port 65002, see HOSTINGER_CREDENTIALS.md)
- **FA Full-Time League Codes**: 
  - Timperley & District JFL: 783655865
  - Salford League: 84363452
- **SSH Access**: `ssh -p 65002 u790502142@82.29.186.226`

---

## 9. Acceptance Criteria

### Completed:
- [x] FA widget page deployed and accessible (with dual league support)
- [x] MySQL database structure created with all tables
- [x] Database credentials securely documented
- [x] Data ingestion endpoint operational
- [x] Public API endpoint live and tested
- [x] **Playwright scraper fully implemented and tested (38 fixtures found)**
- [x] **Multi-league support with smart data handling**

### All Completed:
- [x] Fixtures automatically update twice daily (AWS Lambda - Story 6) ‚úÖ **COMPLETE**
- [x] All Urmston Town teams' fixtures displayed (41 fixtures across 8 age groups) ‚úÖ **LIVE**
- [x] Historical results stored and searchable (database operational)
- [x] Page loads in under 2 seconds ‚úÖ **IN PRODUCTION**
- [x] Mobile responsive design ‚úÖ **DEPLOYED**
- [x] **Production deployment** ‚úÖ **COMPLETE** (Deployed via Hostinger File Manager)
- [x] **Enhanced two-line display format** ‚úÖ **LIVE** (League || Pitch || Venue)
- [x] **Pitch allocation visibility for managers** ‚úÖ **LIVE** (Airtable integration)
- [x] Graceful fallback if scraping fails (retry logic implemented)

---

## Appendix A: Environment Variables

### GitHub Secrets Required
```
HOSTINGER_API_KEY=<to be generated>
SCRAPER_AUTH_TOKEN=a8f3d2b1c9e4f7a6d5b8c3e2f1a9b4c7
HOSTINGER_MYSQL_HOST=localhost
HOSTINGER_MYSQL_USER=u790502142_fixtures
HOSTINGER_MYSQL_PASS=<stored in HOSTINGER_DB_CREDENTIALS.md>
HOSTINGER_MYSQL_DB=u790502142_fixtures
```

### Hostinger .env File (‚úÖ CREATED)
```
DB_HOST=localhost
DB_USER=u790502142_fixtures
DB_PASS=<stored securely>
DB_NAME=u790502142_fixtures
API_AUTH_TOKEN=a8f3d2b1c9e4f7a6d5b8c3e2f1a9b4c7
```
**Location**: `/fixtures-scraper/hostinger/.env`

---

## Appendix B: File Structure

### Local Development Structure
```
/Users/leehayton/ai-apps/urmston-town/
‚îú‚îÄ‚îÄ fixtures-scraper/              # üìÅ MAIN PROJECT DIRECTORY
‚îÇ   ‚îú‚îÄ‚îÄ README.md                  # ‚ö†Ô∏è KEEP THIS UPDATED - Primary reference
‚îÇ   ‚îú‚îÄ‚îÄ scraper/                   # Playwright scraper
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.js              # Main scraper script
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json          # Node dependencies
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ .env.example          # Environment variables template
‚îÇ   ‚îú‚îÄ‚îÄ hostinger/                # Files to deploy to Hostinger
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ fa-widget.html        # FA Full-Time widget page
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                  # PHP endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ fixtures/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ ingest.php   # Receives scraped data
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ get.php      # Public API endpoint
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ .htaccess    # Security rules
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ schema.sql        # MySQL database schema
‚îÇ   ‚îî‚îÄ‚îÄ lambda/                    # AWS Lambda deployment
‚îÇ       ‚îú‚îÄ‚îÄ index-lambda.js        # Lambda handler
‚îÇ       ‚îú‚îÄ‚îÄ Dockerfile            # Container definition (simplified)
‚îÇ       ‚îú‚îÄ‚îÄ deploy.sh            # Deployment script
‚îÇ       ‚îî‚îÄ‚îÄ package.json         # Dependencies
‚îú‚îÄ‚îÄ docs/                          # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ FIXTURES_SCRAPING_PRD.md  # This document
‚îÇ   ‚îî‚îÄ‚îÄ DEVELOPMENT_STORIES.md    # Implementation stories
‚îî‚îÄ‚îÄ [existing Next.js files]      # Current website

```

### Deployed Structure (Hostinger)
```
pages.urmstontownjfc.co.uk/
‚îú‚îÄ‚îÄ fa-widget.html           # Hidden FA widget page
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ fixtures/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ingest.php      # Receives scraped data
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ get.php         # Public API endpoint
‚îÇ   ‚îî‚îÄ‚îÄ .env                # Database credentials
‚îî‚îÄ‚îÄ [existing files]        # Current website files
```

### AWS Lambda Structure
```
AWS Resources (Account: 650251723700, Region: eu-north-1):
‚îú‚îÄ‚îÄ Lambda Function: urmston-fixtures-scraper
‚îÇ   ‚îú‚îÄ‚îÄ Runtime: Container (Node.js 20)
‚îÇ   ‚îú‚îÄ‚îÄ Memory: 1024 MB, Timeout: 120s
‚îÇ   ‚îî‚îÄ‚îÄ Environment Variables: API_TOKEN, WIDGET_URL, API_URL
‚îú‚îÄ‚îÄ ECR Repository: urmston-fixtures-scraper (253MB optimized image)
‚îú‚îÄ‚îÄ EventBridge Rules:
‚îÇ   ‚îú‚îÄ‚îÄ urmston-fixtures-09-00 (9 AM UTC daily)
‚îÇ   ‚îî‚îÄ‚îÄ urmston-fixtures-15-00 (3 PM UTC daily)
‚îî‚îÄ‚îÄ CloudWatch Logs: /aws/lambda/urmston-fixtures-scraper
```

üìù **Note**: See `/fixtures-scraper/README.md` for detailed setup and deployment instructions.